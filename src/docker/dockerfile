# === Stage 1: Base Image with CUDA & System Dependencies ===
FROM nvidia/cuda:11.8.0-cudnn8-devel-ubuntu22.04 AS base

# Set environment variables for CUDA & NVIDIA
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility
ENV CUDA_HOME=/usr/local/cuda
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    wget curl git sudo unzip jq build-essential software-properties-common \
    && rm -rf /var/lib/apt/lists/*

# Install Miniconda
RUN wget https://repo.anaconda.com/miniconda/Miniconda3-py310_23.11.0-2-Linux-x86_64.sh && \
    chmod +x Miniconda3-py310_23.11.0-2-Linux-x86_64.sh && \
    ./Miniconda3-py310_23.11.0-2-Linux-x86_64.sh -b -p /opt/miniconda3 && \
    /opt/miniconda3/bin/conda init bash && \
    echo 'export PATH="/opt/miniconda3/bin:$PATH"' >> ~/.bashrc && \
    . ~/.bashrc

# Set up Conda environment
ENV PATH="/opt/miniconda3/bin:$PATH"
RUN conda update -n base -c defaults conda && \
    conda install -y python=3.10 pip

# Install PyTorch with CUDA support
RUN pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118

# Verify CUDA availability
RUN python -c "import torch; print(torch.cuda.is_available()); print(torch.cuda.get_device_name(0))"

# Create a non-root user (recommended for security)
RUN useradd -m -s /bin/bash comfyuser && echo "comfyuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
USER comfyuser
WORKDIR /home/comfyuser

# === Clone ComfyUI Repository (Main Branch) ===
RUN git clone https://github.com/NewBornAITest/ComfyUI-Installation.git

# Set working directory for installation scripts
WORKDIR /home/comfyuser/ComfyUI-Installation/src
RUN chmod +x virgin_vm.sh install.sh

# === Run Virgin VM Setup Script (Handles All Installations) ===
RUN ./virgin_vm.sh

# === Run Installation Script for ComfyUI ===
RUN ./install.sh

# === Expose Web UI Port ===
EXPOSE 8188

# === Start ComfyUI on Container Startup ===
CMD ["bash", "-c", "source ~/.bashrc && python /home/comfyuser/ComfyUI-NB/main.py --listen"]