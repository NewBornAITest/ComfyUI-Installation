# === Stage 1: Base Image with CUDA & System Dependencies ===
FROM nvidia/cuda:11.8.0-cudnn8-devel-ubuntu22.04 AS base

# Set environment variables for CUDA & NVIDIA
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility
ENV CUDA_HOME=/usr/local/cuda
ENV DEBIAN_FRONTEND=noninteractive  # Prevents interactive prompts

# Install only the essential system dependencies (avoid reinstalling in scripts)
RUN apt-get update && apt-get install -y --no-install-recommends \
    wget curl git sudo unzip jq build-essential software-properties-common keyboard-configuration \
    && rm -rf /var/lib/apt/lists/*

# Configure the keyboard layout (set to US or another layout)
RUN echo "keyboard-configuration keyboard-configuration/layout select US" | debconf-set-selections && \
    dpkg-reconfigure -f noninteractive keyboard-configuration

# Create a non-root user (recommended for security)
RUN useradd -m -s /bin/bash comfyuser && echo "comfyuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
USER comfyuser
WORKDIR /home/comfyuser

# === Clone ComfyUI Repository (Main Branch) ===
RUN git clone https://github.com/NewBornAITest/ComfyUI-Installation.git

# Set working directory for installation scripts
WORKDIR /home/comfyuser/ComfyUI-Installation/src
RUN chmod +x virgin_vm.sh install.sh

# === Run Virgin VM Setup Script (Handles All Installations) ===
RUN ./virgin_vm.sh && source ~/.bashrc

# === Run Installation Script for ComfyUI ===
RUN ./install.sh

# === Expose Web UI Port ===
EXPOSE 8188

# === Start ComfyUI on Container Startup ===
CMD ["bash", "-c", "source ~/.bashrc && python /home/comfyuser/ComfyUI-NB/main.py --listen"]
