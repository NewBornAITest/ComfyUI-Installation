# === Stage 1: Base Image with CUDA & System Dependencies ===
FROM nvcr.io/nvidia/cuda:11.8.0-cudnn8-devel-ubuntu22.04 AS base

# Set environment variables for CUDA & NVIDIA
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility
ENV CUDA_HOME=/usr/local/cuda
ENV DEBIAN_FRONTEND=noninteractive

# Install essential dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    wget curl git sudo unzip jq build-essential software-properties-common keyboard-configuration \
    && rm -rf /var/lib/apt/lists/*

# Configure the keyboard layout (set to US or another layout)
RUN echo "keyboard-configuration keyboard-configuration/layout select US" | debconf-set-selections && \
    dpkg-reconfigure -f noninteractive keyboard-configuration

# Create a non-root user (recommended for security)
RUN useradd -m -s /bin/bash comfyuser && echo "comfyuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
USER comfyuser
WORKDIR /home/comfyuser

# === Install Miniconda in the User's Home Directory ===
RUN wget -q https://repo.anaconda.com/miniconda/Miniconda3-py310_23.11.0-2-Linux-x86_64.sh -O /tmp/miniconda.sh && \
    bash /tmp/miniconda.sh -b -p /home/comfyuser/miniconda3 && \
    rm /tmp/miniconda.sh

# Set Miniconda paths so Python & Pip are globally available
ENV PATH="/home/comfyuser/miniconda3/bin:$PATH"
RUN conda init bash && conda install -y python=3.10 pip

# Confirm Python & Pip installation
RUN python --version && pip --version

# === Clone ComfyUI Repository (Main Branch) ===
RUN git clone https://github.com/NewBornAITest/ComfyUI-Installation.git

# Set working directory for installation scripts
WORKDIR /home/comfyuser/ComfyUI-Installation/src
RUN chmod +x virgin_vm_copy.sh install.sh

# === Run Virgin VM Setup Script (Handles All Installations) ===
RUN /bin/bash -c "source ~/.bashrc && ./virgin_vm_copy.sh"

# === Run Installation Script for ComfyUI ===
RUN /bin/bash -c "source ~/.bashrc && ./install.sh"

# === Expose Web UI Port ===
EXPOSE 8188

# === Start ComfyUI on Container Startup ===
CMD ["bash", "-c", "source ~/.bashrc && python /home/comfyuser/ComfyUI-NB/main.py --listen"]
